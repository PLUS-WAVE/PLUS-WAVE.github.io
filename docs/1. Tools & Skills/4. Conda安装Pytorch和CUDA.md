---
title: Condaå®‰è£…Pytorchå’ŒCUDA/GCCä¸ä¸€äº›ç¯å¢ƒBugè§£å†³
tags:
  - Skills
  - Pytorch
  - Conda
  - CUDA
  - ç¯å¢ƒé…ç½®
createTime: 2024/12/01 15:20:26
permalink: /article/dwpeq4pf/
---





åœ¨å®éªŒå®¤æœåŠ¡å™¨ä¸Šçš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯æ²¡æœ‰ root æƒé™çš„ï¼Œè€ŒæœåŠ¡å™¨å¯èƒ½åªå®‰è£…äº†ç‰¹å®šç‰ˆæœ¬çš„ CUDA å’Œ GCCï¼Œæˆ‘ä»¬å°±éœ€è¦è‡ªå·±å®‰è£…**è‡ªå·±éœ€è¦ç‰ˆæœ¬çš„ CUDA/GCC** æ¥æ»¡è¶³å®‰è£…åŒ…æ—¶çš„ç¯å¢ƒè¦æ±‚ã€‚

è€Œ Conda é™¤äº†å®‰è£… Python çš„åŒ…ä»¥å¤–ï¼Œå…¶**è¿˜æä¾›äº†å¾ˆå¤šå…¶ä»–åº“**â€”â€”æ¯”å¦‚CUDAã€GCCç”šè‡³è¿˜æœ‰ COLMAP<!-- more -->ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®‰è£…è‡ªå·±çš„ç¯å¢ƒçš„å•¦ï¼

è€Œå®˜æ–¹çš„ Conda æ¯”è¾ƒæ…¢ï¼Œä¸€èˆ¬è¿˜å¾—è‡ªå·±æ”¹ channel åˆ° conda-forgeï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ Mamba æ¥æ›¿ä»£ï¼Œå…¶æ¯” Conda æ›´å¿«ï¼Œè€Œä¸”å‘½ä»¤ä¸ Conda ä¸€è‡´ï¼Œåªéœ€æŠŠé€šå¸¸ç”¨çš„ `conda` æ›¿æ¢æˆ `mamba` å³å¯ã€‚å®‰è£…åœ°å€ï¼š[https://github.com/conda-forge/miniforge](https://github.com/conda-forge/miniforge)

## 1 å¿«é€Ÿå®‰è£…ç¯å¢ƒ

è¿™é‡Œå…ˆé™„ä¸Šå„ä¸ªç‰ˆæœ¬Pytorchå’ŒCUDAçš„å®‰è£…å‘½ä»¤åˆé›†ï¼š

- Pytorchï¼š[https://pytorch.org/get-started/previous-versions/](https://pytorch.org/get-started/previous-versions/)
- CUDAï¼š[https://anaconda.org/nvidia/cuda-toolkit](https://anaconda.org/nvidia/cuda-toolkit)

**ä½†æ˜¯æ³¨æ„ï¼Œä¸è¦ç›´æ¥ä½¿ç”¨é‡Œé¢çš„å‘½ä»¤ï¼Œè¦æƒ³è·å¾—è‰¯å¥½çš„ä½“éªŒï¼Œè¯·å‚è€ƒä¸‹é¢çš„ä¾‹å­ï¼š**

ä¸€ä¸ªç®€å•çš„ä¾‹å­å®‰è£… Pytorch 2.3.0ã€CUDA 12.1ã€GCC/G++ 11.4ï¼š

1. å®‰è£… mambaï¼ˆæ¯” conda æ›´å¿«ï¼‰

   ```bash
   wget "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
   bash Miniforge3-$(uname)-$(uname -m).sh
   ```

2. åˆ›å»ºç¯å¢ƒï¼ˆ==æ³¨æ„==ï¼š**æˆ‘è¿™é‡Œä¿®æ”¹äº†å®˜æ–¹çš„ CUDA ç‰ˆæœ¬ Pytorch çš„å®‰è£…å‘½ä»¤**ï¼Œæ”¹å˜äº†channel ä¸º `-c nvidia/label/cuda-12.1.0`ï¼‰

   ```bash
   mamba create -n h_gs python=3.12 -y
   mamba activate h_gs
   mamba install pytorch==2.3.0 torchvision==0.18.0 torchaudio==2.3.0 pytorch-cuda=12.1 -c pytorch -c nvidia/label/cuda-12.1.0
   ```

3. å®‰è£… GCC/G++

   ```bash
   mamba install gcc=11.4
   mamba install gxx=11.4
   ```

4. å®‰è£… CUDAï¼ˆ==æ³¨æ„==ï¼š**æˆ‘è¿™é‡Œä¿®æ”¹äº†å®˜æ–¹çš„ CUDA å®‰è£…å‘½ä»¤**ï¼Œå¤šäº†ä¸€ä¸ª `-c nvidia/label/cuda-12.1.0`ï¼‰

   ```bash
   mamba install nvidia/label/cuda-12.1.0::cuda-toolkit -c nvidia/label/cuda-12.1.0
   ```

å¯ä»¥çœ‹åˆ°ä»¥ä¸Šæ“ä½œæœ‰ä¸¤ä¸ªåœ°æ–¹ç‰¹åˆ«æ³¨æ„çš„ **channel ä¿®æ”¹**ï¼Œæ˜¯å› ä¸ºæ··ä¹±çš„ Conda ç¯å¢ƒç®¡ç†ä¼šå¯¼è‡´åŸç‰ˆå‘½ä»¤å‡ºç° bugï¼Œå…·ä½“æƒ…å†µè¯·çœ‹[ç¬¬3èŠ‚](/article/dwpeq4pf/#_3-2-ld-cannot-find-lcudart)

- Pytorch å®‰è£…çš„ channel ä¿®æ”¹æ˜¯ä¸ºäº†ä½¿ pytorch-cuda ä¸ä¹‹åæˆ‘ä»¬å®‰è£…çš„ CUDA å…¼å®¹

- CUDA å®‰è£…çš„  channel æ·»åŠ æ˜¯ä¸ºäº†é˜²æ­¢å…¶å®‰è£…ä¸ç‰ˆæœ¬ä¸ä¸€æ ·çš„å…¶ä»–CUDAåº“

  > å®‰è£… cuda-toolkit å³æ˜¯å®‰è£…å¾ˆå¤šä¸ª CUDA ç›¸å…³çš„åº“ï¼Œç›´æ¥ä½¿ç”¨[å®˜æ–¹å‘½ä»¤](https://anaconda.org/nvidia/cuda-toolkit)å®‰è£…ä¼šå¯¼è‡´å…¶é¦–å…ˆæŸ¥çœ‹åœ¨é»˜è®¤é¢‘é“å¹¶å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯ `nvidia/label/cuda-12.1.0` ä¸­çš„è½¯ä»¶åŒ…ï¼Œå°±ä¼šå®‰è£…ä¸€äº›æœ€æ–°ç‰ˆæœ¬çš„ CUDA åº“ï¼Œæœ‰ä¸€å®šå‡º bug çš„é£é™©ã€‚

## 2 ç¯å¢ƒè·¯å¾„é—®é¢˜

æ³¨æ„ï¼šConda çš„ CUDAï¼Œç»å¸¸å‡ºç°æ‰¾ä¸åˆ° CUDA ç¯å¢ƒçš„é—®é¢˜ï¼Œä»¥ä¸‹æ“ä½œå¯ä»¥é€šè¿‡å°†ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºæ¿€æ´»æ­¥éª¤çš„ä¸€éƒ¨åˆ†ï¼š

1. è¿›å…¥Condaç¯å¢ƒç›®å½•å¹¶åˆ›å»ºä»¥ä¸‹å­ç›®å½•å’Œæ–‡ä»¶

   ```bash
   cd $CONDA_PREFIX
   mkdir -p ./etc/conda/activate.d
   mkdir -p ./etc/conda/deactivate.d
   touch ./etc/conda/activate.d/env_vars.sh
   touch ./etc/conda/deactivate.d/env_vars.sh
   ```

2. ç¼–è¾‘ `./etc/conda/activate.d/env_vars.sh` å¦‚ä¸‹

   ```bash
   #!/bin/sh
   
   export CUDA_HOME=$CONDA_PREFIX
   export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$LD_LIBRARY_PATH
   ```

3. ç¼–è¾‘ `./etc/conda/deactivate.d/env_vars.sh` å¦‚ä¸‹

   ```bash
   #!/bin/sh
   
   unset CUDA_HOME
   unset LD_LIBRARY_PATH
   ```

å½“è¿è¡Œ `mamba activate analytics` æ—¶ï¼Œç¯å¢ƒå˜é‡ `CUDA_HOME` å’Œ `LD_LIBRARY_PATH` å°†è®¾ç½®ä¸ºå†™å…¥æ–‡ä»¶çš„å€¼ã€‚å½“è¿è¡Œ `mamba deactivate` æ—¶ï¼Œè¿™äº›ç¯å¢ƒå˜é‡å°†è¢«åˆ é™¤ã€‚

è¿™æ ·ç¡®ä¿äº† Conda ç¯å¢ƒæ¿€æ´»çš„æ—¶å€™ï¼Œç¨‹åºå¯ä»¥æ­£ç¡®æ‰¾åˆ° Conda å®‰è£…çš„åŒ…/åº“çš„ä½ç½®

## 3 å„ç§ Bug

### 3.1 undefined symbol: iJIT_NotifyEvent

https://github.com/pytorch/pytorch/issues/123097

åœ¨ä»¥ä¸‹ç¯å¢ƒæ—¶ `import torch` å‘ç”Ÿçš„bugï¼š

```bash
mamba install pytorch==2.0.0 torchvision==0.15.0 torchaudio==2.0.0 pytorch-cuda=11.8 -c pytorch -c nvidia
mamba install nvidia/label/cuda-11.8.0::cuda-toolkit -c nvidia/label/cuda-11.8.0
```

æ­¤æ—¶çš„ `mkl=2024.2.2`ï¼Œæˆ‘ä»¬å°†å…¶é™çº§ä¸º `mkl=2024.0`

```bash
mamba install mkl==2024.0
```

### 3.2 ld: cannot find -lcudart

æˆ‘ä»¬ä½¿ç”¨[ç¬¬1èŠ‚](/article/dwpeq4pf/#_1-å¿«é€Ÿå®‰è£…ç¯å¢ƒ)çš„åŸç‰ˆå‘½ä»¤ï¼ˆæ²¡æœ‰ä¿®æ”¹ channelï¼‰çš„æµç¨‹å®‰è£…pytorchå’ŒCUDAç¯å¢ƒä¹‹åï¼Œè¦ç”¨ Conda çš„ CUDA ç¯å¢ƒè¿›è¡ŒæŸä¸ªåº“ç¼–è¯‘æ—¶ï¼Œå‡ºç°äº†bugï¼š

```bash
/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/compiler_compat/ld: cannot find -lcudart: No such file or directory
      collect2: error: ld returned 1 exit status
      error: command '/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/bin/g++' failed with exit code 1
      [end of output]

  note: This error originates from a subprocess, and is likely not a problem with pip.
  ERROR: Failed building wheel for diff_gaussian_rasterization_32d
  Running setup.py clean for diff_gaussian_rasterization_32d
Failed to build diff_gaussian_rasterization_32d
ERROR: ERROR: Failed to build installable wheels for some pyproject.toml based projects (diff_gaussian_rasterization_32d)
â¯ which nvcc
/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/bin/nvcc
â¯ echo $CUDA_HOME
/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar
â¯ echo $PATH
/home/wangjiawei/local/bin:/home/wangjiawei/local/bin:/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/bin:/mnt/data/home/wangjiawei/miniforge3/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
â¯ echo $LD_LIBRARY_PATH
/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib:
```

å»æ¢æŸ¥å‘ç°ï¼Œè¿™é‡Œçš„è½¯é“¾æ¥å‡ºäº†é—®é¢˜ï¼š

```bash
â¯ ls /mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib

libcudart.so  -> libcudart.so.12.1.55
libcudart.so.12
libcudart.so.12.1.105
```

ç»§ç»­æ¢ç©¶å‘ç°ï¼Œå®‰è£…Pytorchæ—¶ä¼šå®‰è£… `cuda-cudart=12.1.105`

ä»¥ä¸‹æ˜¯æŒ‰ç…§Pytorchæ—¶ä¼šå®‰è£…çš„æ‰€æœ‰ä»¥ `pytorch` ã€ `nvidia` ä¸º channel çš„åŒ…ï¼š

```bash
  + pytorch-mutex         1.0  cuda                          pytorch     Cached
  + libcublas       12.1.0.26  0                             nvidia      Cached
  + libcufft         11.0.2.4  0                             nvidia      Cached
  + libcusolver     11.4.4.55  0                             nvidia      Cached
  + libcusparse     12.0.2.55  0                             nvidia      Cached
  + libnpp          12.0.2.50  0                             nvidia      Cached
  + cuda-cudart      12.1.105  0                             nvidia      Cached
  + cuda-nvrtc       12.1.105  0                             nvidia      Cached
  + libnvjitlink     12.1.105  0                             nvidia      Cached
  + libnvjpeg       12.1.1.14  0                             nvidia      Cached
  + cuda-cupti       12.1.105  0                             nvidia      Cached
  + cuda-nvtx        12.1.105  0                             nvidia      Cached
  + ffmpeg                4.3  hf484d3e_0                    pytorch     Cached
  + libjpeg-turbo       2.0.0  h9bf148f_0                    pytorch     Cached
  + cuda-version         12.6  3                             nvidia      Cached
  + libcurand       10.3.7.77  0                             nvidia      Cached
  + libcufile        1.11.1.6  0                             nvidia      Cached
  + cuda-opencl       12.6.77  0                             nvidia      Cached
  + cuda-libraries     12.1.0  0                             nvidia      Cached
  + cuda-runtime       12.1.0  0                             nvidia      Cached
  + pytorch-cuda         12.1  ha16c6d3_6                    pytorch     Cached
  + pytorch             2.4.1  py3.12_cuda12.1_cudnn9.1.0_0  pytorch     Cached
  + torchtriton         3.0.0  py312                         pytorch     Cached
  + torchaudio          2.4.1  py312_cu121                   pytorch     Cached
  + torchvision        0.19.1  py312_cu121                   pytorch     Cached
```

è€Œè¿™æ˜¯å®‰è£… `cuda-toolkit-12.1.0` çš„åŒ…ï¼š

```bash
  + cuda-documentation           12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvml-dev                12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + libnvvm-samples              12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-cccl                    12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-driver-dev              12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-profiler-api            12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-cudart                  12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvrtc                   12.1.55  0      nvidia/label/cuda-12.1.0       21MB
  + cuda-opencl                  12.1.56  0      nvidia/label/cuda-12.1.0       11kB
  + libcublas                  12.1.0.26  0      nvidia/label/cuda-12.1.0     Cached
  + libcufft                    11.0.2.4  0      nvidia/label/cuda-12.1.0     Cached
  + libcufile                   1.6.0.25  0      nvidia/label/cuda-12.1.0      782kB
  + libcurand                  10.3.2.56  0      nvidia/label/cuda-12.1.0       54MB
  + libcusolver                11.4.4.55  0      nvidia/label/cuda-12.1.0     Cached
  + libcusparse                12.0.2.55  0      nvidia/label/cuda-12.1.0     Cached
  + libnpp                     12.0.2.50  0      nvidia/label/cuda-12.1.0     Cached
  + libnvjitlink                 12.1.55  0      nvidia/label/cuda-12.1.0       18MB
  + libnvjpeg                  12.1.0.39  0      nvidia/label/cuda-12.1.0        3MB
  + cuda-cupti                   12.1.62  0      nvidia/label/cuda-12.1.0        5MB
  + cuda-cuobjdump               12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-cuxxfilt                12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvcc                    12.1.66  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvprune                 12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-gdb                     12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvdisasm                12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvprof                  12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvtx                    12.1.66  0      nvidia/label/cuda-12.1.0       58kB
  + cuda-sanitizer-api           12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nsight                  12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + nsight-compute           2023.1.0.15  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-cudart-dev              12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvrtc-dev               12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-opencl-dev              12.1.56  0      nvidia/label/cuda-12.1.0     Cached
  + libcublas-dev              12.1.0.26  0      nvidia/label/cuda-12.1.0     Cached
  + libcufft-dev                11.0.2.4  0      nvidia/label/cuda-12.1.0     Cached
  + gds-tools                   1.6.0.25  0      nvidia/label/cuda-12.1.0     Cached
  + libcufile-dev               1.6.0.25  0      nvidia/label/cuda-12.1.0     Cached
  + libcurand-dev              10.3.2.56  0      nvidia/label/cuda-12.1.0     Cached
  + libcusolver-dev            11.4.4.55  0      nvidia/label/cuda-12.1.0     Cached
  + libcusparse-dev            12.0.2.55  0      nvidia/label/cuda-12.1.0     Cached
  + libnpp-dev                 12.0.2.50  0      nvidia/label/cuda-12.1.0     Cached
  + libnvjitlink-dev             12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + libnvjpeg-dev              12.1.0.39  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-libraries                12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-cupti-static            12.1.62  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-compiler                 12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvvp                    12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-command-line-tools       12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nsight-compute           12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-cudart-static           12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-nvrtc-static            12.1.55  0      nvidia/label/cuda-12.1.0     Cached
  + libcublas-static           12.1.0.26  0      nvidia/label/cuda-12.1.0     Cached
  + libcufft-static             11.0.2.4  0      nvidia/label/cuda-12.1.0     Cached
  + libcufile-static            1.6.0.25  0      nvidia/label/cuda-12.1.0     Cached
  + libcurand-static           10.3.2.56  0      nvidia/label/cuda-12.1.0     Cached
  + libcusolver-static         11.4.4.55  0      nvidia/label/cuda-12.1.0     Cached
  + libcusparse-static         12.0.2.55  0      nvidia/label/cuda-12.1.0     Cached
  + libnpp-static              12.0.2.50  0      nvidia/label/cuda-12.1.0     Cached
  + libnvjpeg-static           12.1.0.39  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-libraries-dev            12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-libraries-static         12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-visual-tools             12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-tools                    12.1.0  0      nvidia/label/cuda-12.1.0     Cached
  + cuda-toolkit                  12.1.0  0      nvidia/label/cuda-12.1.0     Cached
```

è¿™æ˜¯å®‰è£… `cuda-toolkit-12.1.1` çš„åŒ…ï¼š

```bash
  + cuda-documentation         12.1.105  0      nvidia/label/cuda-12.1.1       91kB
  + cuda-nvml-dev              12.1.105  0      nvidia/label/cuda-12.1.1       87kB
  + libnvvm-samples            12.1.105  0      nvidia/label/cuda-12.1.1       33kB
  + cuda-cccl                  12.1.109  0      nvidia/label/cuda-12.1.1        1MB
  + cuda-driver-dev            12.1.105  0      nvidia/label/cuda-12.1.1       17kB
  + cuda-profiler-api          12.1.105  0      nvidia/label/cuda-12.1.1       19kB
  + cuda-cudart                12.1.105  0      nvidia/label/cuda-12.1.1     Cached
  + cuda-nvrtc                 12.1.105  0      nvidia/label/cuda-12.1.1     Cached
  + cuda-opencl                12.1.105  0      nvidia/label/cuda-12.1.1       11kB
  + libcublas                  12.1.3.1  0      nvidia/label/cuda-12.1.1      367MB
  + libcufft                  11.0.2.54  0      nvidia/label/cuda-12.1.1      108MB
  + libcufile                   1.6.1.9  0      nvidia/label/cuda-12.1.1      783kB
  + libcurand                10.3.2.106  0      nvidia/label/cuda-12.1.1       54MB
  + libcusolver              11.4.5.107  0      nvidia/label/cuda-12.1.1      116MB
  + libcusparse              12.1.0.106  0      nvidia/label/cuda-12.1.1      177MB
  + libnpp                    12.1.0.40  0      nvidia/label/cuda-12.1.1      147MB
  + libnvjitlink               12.1.105  0      nvidia/label/cuda-12.1.1     Cached
  + libnvjpeg                  12.2.0.2  0      nvidia/label/cuda-12.1.1        3MB
  + cuda-cupti                 12.1.105  0      nvidia/label/cuda-12.1.1     Cached
  + cuda-cuobjdump             12.1.111  0      nvidia/label/cuda-12.1.1      245kB
  + cuda-cuxxfilt              12.1.105  0      nvidia/label/cuda-12.1.1      302kB
  + cuda-nvcc                  12.1.105  0      nvidia/label/cuda-12.1.1       55MB
  + cuda-nvprune               12.1.105  0      nvidia/label/cuda-12.1.1       67kB
  + cuda-gdb                   12.1.105  0      nvidia/label/cuda-12.1.1        6MB
  + cuda-nvdisasm              12.1.105  0      nvidia/label/cuda-12.1.1       50MB
  + cuda-nvprof                12.1.105  0      nvidia/label/cuda-12.1.1        5MB
  + cuda-nvtx                  12.1.105  0      nvidia/label/cuda-12.1.1     Cached
  + cuda-sanitizer-api         12.1.105  0      nvidia/label/cuda-12.1.1       18MB
  + cuda-nsight                12.1.105  0      nvidia/label/cuda-12.1.1      119MB
  + nsight-compute           2023.1.1.4  0      nvidia/label/cuda-12.1.1      808MB
  + cuda-cudart-dev            12.1.105  0      nvidia/label/cuda-12.1.1      381kB
  + cuda-nvrtc-dev             12.1.105  0      nvidia/label/cuda-12.1.1       12kB
  + cuda-opencl-dev            12.1.105  0      nvidia/label/cuda-12.1.1       59kB
  + libcublas-dev              12.1.3.1  0      nvidia/label/cuda-12.1.1       76kB
  + libcufft-dev              11.0.2.54  0      nvidia/label/cuda-12.1.1       14kB
  + gds-tools                   1.6.1.9  0      nvidia/label/cuda-12.1.1       43MB
  + libcufile-dev               1.6.1.9  0      nvidia/label/cuda-12.1.1       13kB
  + libcurand-dev            10.3.2.106  0      nvidia/label/cuda-12.1.1      460kB
  + libcusolver-dev          11.4.5.107  0      nvidia/label/cuda-12.1.1       51kB
  + libcusparse-dev          12.1.0.106  0      nvidia/label/cuda-12.1.1      178MB
  + libnpp-dev                12.1.0.40  0      nvidia/label/cuda-12.1.1      525kB
  + libnvjitlink-dev           12.1.105  0      nvidia/label/cuda-12.1.1       15MB
  + libnvjpeg-dev              12.2.0.2  0      nvidia/label/cuda-12.1.1       13kB
  + cuda-libraries               12.1.1  0      nvidia/label/cuda-12.1.1        2kB
  + cuda-cupti-static          12.1.105  0      nvidia/label/cuda-12.1.1       12MB
  + cuda-compiler                12.1.1  0      nvidia/label/cuda-12.1.1        1kB
  + cuda-nvvp                  12.1.105  0      nvidia/label/cuda-12.1.1      120MB
  + cuda-command-line-tools      12.1.1  0      nvidia/label/cuda-12.1.1        1kB
  + cuda-nsight-compute          12.1.1  0      nvidia/label/cuda-12.1.1        1kB
  + cuda-cudart-static         12.1.105  0      nvidia/label/cuda-12.1.1      948kB
  + cuda-nvrtc-static          12.1.105  0      nvidia/label/cuda-12.1.1       18MB
  + libcublas-static           12.1.3.1  0      nvidia/label/cuda-12.1.1      389MB
  + libcufft-static           11.0.2.54  0      nvidia/label/cuda-12.1.1      199MB
  + libcufile-static            1.6.1.9  0      nvidia/label/cuda-12.1.1        3MB
  + libcurand-static         10.3.2.106  0      nvidia/label/cuda-12.1.1       55MB
  + libcusolver-static       11.4.5.107  0      nvidia/label/cuda-12.1.1       76MB
  + libcusparse-static       12.1.0.106  0      nvidia/label/cuda-12.1.1      185MB
  + libnpp-static             12.1.0.40  0      nvidia/label/cuda-12.1.1      143MB
  + libnvjpeg-static           12.2.0.2  0      nvidia/label/cuda-12.1.1        3MB
  + cuda-libraries-dev           12.1.1  0      nvidia/label/cuda-12.1.1        2kB
  + cuda-libraries-static        12.1.1  0      nvidia/label/cuda-12.1.1        2kB
  + cuda-visual-tools            12.1.1  0      nvidia/label/cuda-12.1.1        1kB
  + cuda-tools                   12.1.1  0      nvidia/label/cuda-12.1.1        1kB
  + cuda-toolkit                 12.1.1  0      nvidia/label/cuda-12.1.1        2kB
```

å¯¹æ¯”å‘ç°æ˜¯ `cuda-12.1.1` æ‰å¯¹çš„ä¸ŠCUDAç‰ˆæœ¬12.1çš„Pytorchã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨å®‰è£…çš„æ—¶å€™ï¼Œå…ˆå®‰è£…CUDAç‰ˆæœ¬12.1çš„Pytorchï¼Œå†å®‰è£… `cuda-12.1.1` ä¼šå‡ºç°å†²çªé—®é¢˜ï¼š

```bash
â””â”€ pytorch-cuda is not installable because it requires
   â””â”€ libcublas >=12.1.0.26,<12.1.3.1 , which conflicts with any installable versions previously reported.
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥æ­»çš„CUDAç‰ˆæœ¬12.1çš„Pytorchçš„ `libcublas` éœ€è¦é€‚é… `cuda-toolkit-12.1.0` ï¼Œä½†æ˜¯å…¶çš„ `cuda-cudart` ç­‰åº“åˆéœ€è¦é€‚é… `cuda-toolkit-12.1.1` 

å¯ä»¥çœ‹åˆ° pytorch-cuda å¼ºè¦æ±‚ `libcublas >=12.1.0.26,<12.1.3.1`ï¼Œæˆ‘ä»¬åªå¥½è¿å°± pytorchï¼Œå®‰è£…12.1.0çš„CUDAï¼Œä½†æ˜¯å‘¢ï¼==æˆ‘ä»¬å¯ä»¥ä¿®æ”¹Pytorchå®˜æ–¹ç»™å‡ºçš„ `nvidia` channel ä¸º `nvidia/label/cuda-12.1.0`==

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
mamba install pytorch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 pytorch-cuda=12.1 -c pytorch -c nvidia/label/cuda-12.1.0
```

å…¶å°±ä¼šå®‰è£…ä¸æˆ‘ä»¬å®‰è£…çš„ `cuda-toolkit-12.1.0` ä¸€æ ·çš„ä¸€äº› cuda åº“äº†ï¼

```bash
  + pytorch-mutex         1.0  cuda                          pytorch                      Cached
  + libcublas       12.1.0.26  0                             nvidia/label/cuda-12.1.0     Cached
  + libcufft         11.0.2.4  0                             nvidia/label/cuda-12.1.0     Cached
  + libcusolver     11.4.4.55  0                             nvidia/label/cuda-12.1.0     Cached
  + libcusparse     12.0.2.55  0                             nvidia/label/cuda-12.1.0     Cached
  + libnpp          12.0.2.50  0                             nvidia/label/cuda-12.1.0     Cached
  + libnvjpeg       12.1.0.39  0                             nvidia/label/cuda-12.1.0        3MB
  + cuda-cudart       12.1.55  0                             nvidia/label/cuda-12.1.0     Cached
  + cuda-nvrtc        12.1.55  0                             nvidia/label/cuda-12.1.0       21MB
  + cuda-opencl       12.1.56  0                             nvidia/label/cuda-12.1.0       11kB
  + libcufile        1.6.0.25  0                             nvidia/label/cuda-12.1.0      782kB
  + libcurand       10.3.2.56  0                             nvidia/label/cuda-12.1.0       54MB
  + cuda-cupti        12.1.62  0                             nvidia/label/cuda-12.1.0        5MB
  + cuda-nvtx         12.1.66  0                             nvidia/label/cuda-12.1.0       58kB
  + cuda-version         12.1  h1d6eff3_3                    conda-forge                    21kB
  + ffmpeg                4.3  hf484d3e_0                    pytorch                      Cached
  + libjpeg-turbo       2.0.0  h9bf148f_0                    pytorch                      Cached
  + libnvjitlink     12.1.105  hd3aeb46_0                    conda-forge                    16MB
  + cuda-libraries     12.1.0  0                             nvidia/label/cuda-12.1.0     Cached
  + cuda-runtime       12.1.0  0                             nvidia/label/cuda-12.1.0     Cached
  + pytorch-cuda         12.1  ha16c6d3_6                    pytorch                      Cached
  + pytorch             2.4.1  py3.12_cuda12.1_cudnn9.1.0_0  pytorch                      Cached
  + torchtriton         3.0.0  py312                         pytorch                      Cached
  + torchvision        0.19.1  py312_cu121                   pytorch                      Cached
  + torchaudio          2.4.1  py312_cu121                   pytorch                      Cached
```

åˆ°è¿™é‡Œï¼Œé—®é¢˜å°±è§£å†³äº†ï¼šæˆ‘ä»¬ä¹‹åè¦å®‰è£… pytorch-cuda å’Œ cuda-toolkit æ—¶ï¼Œåªéœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆé¡ºåºåº”è¯¥ä¸é‡è¦äº†ï¼‰ï¼š

```bash
mamba install pytorch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 pytorch-cuda=12.1 -c pytorch -c nvidia/label/cuda-12.1.0
mamba install nvidia/label/cuda-12.1.0::cuda-toolkit -c nvidia/label/cuda-12.1.0
```

å®‰è£… cuda-toolkit å°±ç›¸å½“äºåœ¨å®‰è£…å®Œ pytorch-cuda çš„éœ€è¦çš„éƒ¨åˆ† cuda åº“åï¼Œè¿›è¡Œäº†è¡¥å……å®‰è£…ï¼Œéƒ½æ˜¯åŒä¸€ä¸ª channel çš„å½“ç„¶å°±ä¸ä¼šæœ‰é—®é¢˜äº†

### 3.3 libstdc++.so.6: version `GLIBCXX_3.4.29' not found

åœ¨ conda ç¯å¢ƒå®‰è£… gcc/gxx ä¹‹åï¼Œè¿è¡Œå¼€å§‹é‡åˆ°äº†ä»¥ä¸‹çš„æŠ¥é”™

```bash
  File "/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/python3.12/site-packages/google/protobuf/internal/wire_format.py", line 13, in <module>
    from google.protobuf import descriptor
  File "/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/python3.12/site-packages/google/protobuf/descriptor.py", line 28, in <module>
    from google.protobuf.pyext import _message
ImportError: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version `GLIBCXX_3.4.29' not found (required by /mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/python3.12/site-packages/google/protobuf/pyext/_message.cpython-312-x86_64-linux-gnu.so)`
```

æ’æŸ¥å‘ç°ï¼š

åœ¨ conda ç¯å¢ƒä¸­æ‰¾ä¸åˆ° `libstdc++.so.6` ï¼ä¸è¿‡èƒ½æ‰¾åˆ° `libstdc++.so.6.0.33`

```bash
â¯ strings /mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/libstdc++.so.6 | grep GLIBCXX
strings: '/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/libstdc++.so.6': No such file

â¯ ls /mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/libstdc++*
/mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/libstdc++.so.6.0.33
```

çœ‹æ¥æ˜¯è½¯é“¾æ¥å‡ºäº†é—®é¢˜ï¼Œæˆ‘å°è¯•äº†é‡æ–°åœ¨ conda ç¯å¢ƒå®‰è£… gcc/gxxï¼Œä½†æ˜¯å§‹ç»ˆæ— æ³•è§£å†³è½¯é“¾æ¥é—®é¢˜ï¼Œè€Œä¸”åœ¨å¸è½½ä¹‹åï¼Œè¿™ä¸ª `libstdc++.so.6.0.33` ä¾æ—§å­˜åœ¨ï¼Œçœ‹æ¥æ˜¯æŸä¸ªåº“çš„é—®é¢˜ã€‚

è¿™æ ·å¤ªéš¾æ’æŸ¥äº†ï¼Œæ‰€ä»¥ç›´æ¥é‡‡å–æœ€ç®€å•çš„åŠæ³•â€”â€”è‡ªå·±æ‰‹åŠ¨è½¯é“¾æ¥ï¼š

```bash
ln -s /mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/x86_64-conda-linux-gnu/lib/libstdc++.so.so.6.0.33 \
      /mnt/data/home/wangjiawei/miniforge3/envs/GAGAvatar/lib/libstdc++.so.6
```

é—®é¢˜æš‚æ—¶è§£å†³ğŸ˜‹



## å‚è€ƒ

[https://stackoverflow.com/questions/72684130/how-to-set-the-cuda-path-in-the-conda-environment](https://stackoverflow.com/questions/72684130/how-to-set-the-cuda-path-in-the-conda-environment)

[https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#saving-environment-variables](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#saving-environment-variables)

[https://stackoverflow.com/questions/78484090/conda-cuda12-incompatibility/78843983#78843983](https://stackoverflow.com/questions/78484090/conda-cuda12-incompatibility/78843983#78843983)
